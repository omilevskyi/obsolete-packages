---
name: Update modules

on:
  workflow_dispatch:

jobs:
  update-modules:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # 5.0.0
        with:
          fetch-depth: 1
          show-progress: "false"
      - name: Setup Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # 6.1.0
        with:
          go-version-file: "go.mod"
          cache-dependency-path: "go.sum"
          check-latest: true
          cache: true
      - run: go get -u=patch
      - run: go mod tidy
      - name: Build binary
        run: |
          env GOOS=linux GOARCH=amd64 CGO_ENABLED=0 \
            go build -trimpath -buildvcs=false \
              -buildmode=exe \
              -ldflags "-s -w -extldflags -static" \
              -tags 'static_build' \
              -o bootstrap
      - run: go test -v ./...
      - run: git config user.email 'github@github.com'
      - run: git config user.name 'GitHub Build'
      - run: git checkout -b fix/${{ github.run_number }}
      - run: |
          git commit --all --message 'fix: update module versions ${{ github.run_number }}'
      - run: git push --set-upstream origin $(git branch --show-current)
      - run: gh pr create --fill
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
